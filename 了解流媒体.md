---
title: 了解流媒体
tags:
  - 流媒体
toc: true
date: 2016-10-23 19:20:44
categories: 学习总结
---

### 基本概念
流媒体相关的一些基础概念：
**帧：** 一帧就是一副静止的图像
<!--more-->
**帧率：** 每秒显示的图片数，影响画面流畅度，与画面流畅度成正比；`帧率`越大，画面越流畅，`帧率`越小，画面越有跳动感；

> 由于人类眼睛的特殊生理结构，如果看到画面的`帧率` > 16的时候，会感觉这个画面是连贯的，此现象称之为*视觉暂留*，并且当`帧率`达到一定数值后，在增长的话，人眼也不容易察觉到有明显的流畅度提升。

**码率：** 图片进行压缩后每秒显示的数据量
**分辨率：** 图片的长度和宽度，也就是图片的尺寸
**GOP：** （Group of Pictures）画面组，一个`GOP`就是一组连续的画面，每个画面都是一帧，一个`GOP`就是很多帧的集合。

> 直播平台的视频数据，就是一组图片，包括`I帧`、`B帧`、`P帧`，当用户第一次观看的时候，会寻找`I帧`，而播放器会到服务器寻找到最近的`I帧`反馈给用户，因此`GOP cache`增加了端到端延迟，因为它必须要拿到最近的`I帧`。
>`GOP cache`的长度越长，画面质量越好

**流媒体开发：** 网络层（socket）负责传输，协议层（rtmp）负责打包数据，封装层（flv、ts）负责编解码数据的封装，编码层（h.264）负责图像音频的压缩
**压缩前的数据量：** 帧率 \* 分辨率
**压缩比：** 压缩前的数据量和压缩后的数据量的比值，也就是（帧率 * 分辨率）/ 码率

> 对于同一个视频源并采用同一种视频编码算法，则压缩比越高画面质量越差

**视频文件格式：** 音视频文件的后缀，比如 .avi、.mp4、.mp3、.rmvb

> 根据文件的格式，系统判断使用什么软件打开视频文件
> 随意修改文件格式，对文件本身不会造成太大的影响，比如把`avi`改成`mp4`，文件还是`avi`

**视频封装格式：** 一种存储视频信息的容器，流式封装可以有`TS、FLV`等，索引式的封装有`mp4、avi`等

> 主要的作用：一个视频文件往往包含图像和音频信息，还有一些配置信息（比如编解码信息，图像和音频的关联等），这些内容需要按照一定的规则组织、封装起来
> 一般视频文件格式的后缀名采用相应的视频封装格式名称，所以视频文件格式就是视频封装格式

### 视频处理
**视频处理原理：** 视频最终也是通过GPU，一帧一帧渲染到屏幕上的，所以可以使用OpenGL ES，对视频进行加工处理，使视频呈现出不同的效果

> 现在各种美颜和视频添加特效的app都是利用`GPUImage`这个框架来实现的

**视频处理框架：**

 1. `GPUImage`：是基于OpenGL ES的一个强大的图像视频处理框架，封装好了各种滤镜，也可以编写自定义的滤镜，其本身内置了多达*120*种常见的滤镜效果
 2. `OpenGL `：(Open Graphics Library)定义了一个跨编程语言、跨平台的编程接口的规格，用于二维三维图像，是一个很专业的图形程序接口，功能强大，调用方便的底层图形库
 3. `Open GL ES`：是`Open GL `三维图形API子集，针对手机和游戏主机等嵌入式设备而设计

### 视频编解码
**视频压缩编码标准：** 对视频进行压缩（视频编码）和解压缩（视频解码）的编码技术

> 主要作用：是将视频像素数据压缩成视频码流，从而降低视频的数据量，如果视频不经过压缩编码的话，都是很大的。影响视频质量的是其视频编码数据和音频编码数据，跟封装格式没有多大关系


**MPEG：** 一种视频压缩方式，它采用了帧间压缩，仅存储连续帧之间有差异的地方，从而达到较大的压缩比
**H.264：** 一种视频压缩方式，采用事先预测和与`MPEG`中的P-B帧一样的帧预测方式压缩，它可以根据需要产生适合网络情况传输的视频流，还有更高的压缩比，有更好的图像质量
> 如果从单个画面清晰度比较，`MPEG`有优势，从连贯性上比较的话，`H.264`有优势；`H.264`算法复杂，需要更多的处理器和内存资源，对系统要求较高

**H.265：** 基于`H.264`，对一些相关技术进行改进，改善码流、编码质量、延时和算法复杂度之间的关系，达到最优化

> `H.265`更高效，能够在同等画质效果下将内容的体积压缩的更小，传输时更快更省带宽

**FFmpeg：** 是一个跨平台的开源视频框架，能实现视频编码、解码、转码、串流、播放等功能，支持的视频格式以及播放协议非常丰富，几乎包含了所有音视频编解码、封装格式以及播放协议

### I/B/P帧，帧内、帧间
**I帧：** 也是关键帧，保留一副完整的画面，解码时只需要本帧数据就可以完成
**P帧：** 差别帧，保留这一帧跟之前帧的差别，解码时需要用之前缓存的画面叠加上本帧定义的差别，生成最终的画面

> `P帧`没有完整画面数据，只有与前一帧画面差别的数据

**B帧：** 双向差别帧，保留本帧与前后帧之间的差别，解码时`B帧`不仅要取得之前的缓存画面，还有解码之后的画面，通过前后画面与本帧数据的叠加取得最终的画面

> `B帧`压缩率高，但解码是CPU工作较多

**帧内压缩：** 当压缩一帧图像时，仅考虑本帧数据而不考率相邻帧之间冗余信息

> `帧内压缩`一般采用有损压缩算法

**帧间压缩：**时间压缩，通常比较时间轴上不同帧之间的数据进行压缩

> `帧间压缩`一般是无损的

**合成：** 将视频流、音频流甚至是字幕流封装到一个文件中，作为一个信号进行传输

### 流媒体服务器
**SRS：** 优秀开源的流媒体服务器系统
**BMS：** `SRS`的商业版，有更多的功能
**nginx：** 免费开源web服务器，常用来配置流媒体服务器
**数据分发（CDN）：** 将内容分发到网络，发布到最接近用户的网络边缘，使用户更容易拿到内容，解决网络拥堵状况，提高用户访问网站的响应速度
**CDN工作原理：**

 1. 上传流媒体数据到源服务器
 2. 源服务器保存流媒体数据
 3. 客户端播放流媒体数据时，向`CDN`请求编码后的流媒体数据
 4. `CDN`的服务器响应请求，如果节点上不存在该流媒体数据，则向源服务器请求流媒体数据，如果存在，则执行6
 5. 源服务器响应`CDN`的请求，将流媒体分发到响应的`CDN`节点上
 6. `CDN`将流媒体数据发到客户端

**负载均衡：** 由多台服务器以对称的方式组成一个服务器集合，每台服务器都具有等价的地位，都可以单独对外提供服务而无需其他服务器的辅助。通过某种负载分担技术，将外部发送来的请求均匀分配到对称结构中的某一台服务器上，而接收到请求的服务器独立地回应客户的请求

> `负载均衡`能够平均分配客户请求到服务器列阵，以提供快速获取数据，解决大量并发访问服务器问题

### 解码
**硬解码：** 用GPU来解码，减少CPU运算

> 优点：播放流畅，低功耗，解码速度快
> 缺点：兼容性不好

**软解码：** 用CPU解码

> 优点：兼容性好
> 缺点：加大CPU负担，不够流畅，解码速度相对慢，耗电增加

